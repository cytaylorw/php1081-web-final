<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>政府開放資料 - 展覽資訊</title>
    <!-- favicon -->
    <link rel="shortcut icon" href="./icon/favicon.ico" type="image/x-icon">
    <!-- 網站meta  -->
    <meta name="keywords" content="展覽資訊,文化部,政府開放資料">
    <meta name="description" content="台灣展覽資訊">
    <meta name="author" content="泰山網頁設計班">
    <!-- facebook meta -->
    <meta property="og:title" content="政府開放資料 - 展覽資訊">
    <meta property="og:image" content="./icon/folder512.png">
    <meta property="og:description" content="台灣展覽資訊">
    <meta property="og:site_name" content="政府開放資料 - 展覽資訊">
    <link rel="stylesheet" href="./css/main.css">
    <!-- 先jquery -->
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/wow.min.js"></script>
    <script src="./js/css-doodle.min.js"></script>
    <script src="./js/particles.min.js"></script>
    <script src="./js/jquery.dataTables.min.js"></script>
    <script src="./js/dataTables.bootstrap4.min.js"></script>
    <script src="./js/Chart.min.js"></script>
    <!-- PWD -->
    <link rel="manifest" href="./manifest.json">
</head>

<body data-spy="scroll" data-target="#nav">
    <div id="bg" class="bg">
        <div id="day" class="bg">
            <div id="cloud"></div>
            <div class="rotate-wrap rotate-sun">                
                <css-doodle id="sun" class="self-rotate">
                    :doodle {
                        @grid: 5x1 / 8em;
                        @shape: circle;
                        }
                    @shape: circle;
                    @nth(1) { @place-cell: center; background: #f2c559; @size: calc(110% / 4 * @index()); animation-name: shine1;};
                    @nth(2) { @place-cell: center; background: #d69415; @size: calc(110% / 4 * @index()); animation-name: shine2;};
                    @nth(3) { @place-cell: center; background: #e59a27; @size: calc(100% / 4 * @index());};
                    @nth(4) { @place-cell: center; background: #f2740b; @size: calc(90% / 4 * @index());};
                    @nth(5) { @place-cell: center; background: #e36700; @size: calc(90% / 4 * @index());};
                    opacity: calc(1.2 - 1 / 7 * @index());
                    z-index: calc(5 - @index());
                    animation-duration: 3s;
                    animation-iteration-count: infinite;
                    animation-timing-function: ease-in;
                    animation-direction: alternate;
        
                    @keyframes shine1 {
                        0% {
                            top: @rand(40,60)%; left: @rand(40,60)%;
                        }
                        100%{
                            top: @rand(40,60)%; left: @rand(40,60)%;
                        }
                    }
                    @keyframes shine2 {
                        0% {
                            top: @rand(35,65)%; left: @rand(35,65)%;
                        }
                        100%{
                            top: @rand(35,65)%; left: @rand(35,65)%;
                        }
                    }
                </css-doodle>
            </div>
            
        </div>
        <div id="night" class="bg">
                <div class="rotate-wrap rotate-moon">
                        <css-doodle id="moon" class="self-rotate">
                                :doodle {
                                    @grid: 10x1 / 8em;
                                    @shape: circle;
                                  }
                                @shape: circle;
                                @nth(n+1) { @place-cell: @rand(10,90)% @rand(10,90)%; background: #46434C; @size: calc(2% * @rand(1,10)); z-index:0;};
                                @nth(@size()-1) { @place-cell: center; background: #EAE8FE; @size: 90%; z-index:-1;};
                                @nth(@size()) { @place-cell: center; background: #EAE8FE; @size: 100%; z-index:-2; opacity:0.9;animation-name: glow};
                                animation-duration: 3s;
                                animation-iteration-count: infinite;
                                animation-timing-function: ease-in;
                                animation-direction: alternate;
                    
                                @keyframes glow {
                                    0% {
                                        opacity: 0.9;
                                    }
                                    100%{
                                        opacity: 0.3;
                                    }
                                }
                        </css-doodle>
                    </div>
        </div>

    </div>
    <nav class="navbar navbar-expand navbar-light bg-nav fixed-top shadow flipInX wow" id="nav">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="./icon/folder64.png" width="30" height="30" class="d-inline-block align-top" alt="東山咖啡">
                <span class="d-none d-md-inline">政府開放資料 - 展覽資訊</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#stastiticWrap">
                            <i class="fas fa-poll"></i> <span class="d-none d-sm-inline">統計</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#searchTitle">
                            <i class="fas fa-search"></i> <span class="d-none d-sm-inline">找展覽</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#result">
                            <i class="fas fa-table"></i> <span class="d-none d-sm-inline">展覽資料</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container" id="content">
        <div class="row pt-nav" id="stastiticWrap">
            <div class="row map-wrap w-100 d-none d-md-flex">
                <div class="col-12 text-center text-dark tada wow" id="mapTitle">
                    <h2 class="mx-6 bg-white-50 rounded">展覽統計(共<span id="total"></span>筆)</h2>
                </div>
                <div class="container position-absolute z-5">
                    <div class="col-12">
                        <div class="float-left">
                                <a id="c99" href="#" class="btn btn-info active other-city" role="button" aria-pressed="true">
                                    <span class="text-wrap">未提供</span></a>
                        </div>
                        <div class="float-right">
                                <a id="c98" href="#" class="btn btn-info active other-city" role="button" aria-pressed="true">
                                    <span class="text-wrap px-2">其他</span></a>
                        </div>
                    </div>
                </div>                
                <div class="col-12 text-center" id="map">
                    <!-- svg -->
                </div>
            </div>
            <div class="row pie-wrap w-100 mb-5 d-flex d-md-none">
                <div class="col-12">
                        <canvas class="w-100" id="chart"></canvas>
                </div>
            </div>
            
        </div>
        <div class="row justify-content-center">
            <div class="col-6  col-sm-4 col-md-3 col-lg-2 text-center">
                <a href="#citySelect" class="text-light no-decoration">
                    <h4 class="arrow-down pb-1 bg-color2 bounce animated slower infinite">找展覽<br>
                        <i class="fas fa-arrow-down"></i>
                    </h4>
                </a>
            </div>
        </div>
        <div class="row my-5 search-options bg-black-50" id="searchSelect">
                <div class="col-12 text-center text-dark tada wow">
                        <h2 class="my-3 py-1 bg-white-50 rounded" id="searchTitle">搜尋條件</h2>
                    </div>
            <div class="col-12 col-lg-6">
                    <div class="form-group bg-dark text-white rounded">
                            <label for="citySelect" class="w-100 text-center pt-1">縣市</label>
                            <select class="form-control" id="citySelect"  data-next="yearSelect">
                            </select>
                          </div>
            </div>
            <div class="col-12 col-lg-6">
                    <div class="form-group bg-dark text-white rounded">
                            <label for="yearSelect" class="w-100 text-center pt-1">年</label>
                            <select class="form-control" id="yearSelect"  data-next="monthSelect">
                            </select>
                          </div>
            </div>
            <div class="col-12 col-lg-6">
                    <div class="form-group bg-dark text-white rounded">
                            <label for="saleSelect" class="w-100 text-center pt-1">是否售票</label>
                            <select class="form-control" id="saleSelect" data-next="confirm">
                              <option value="0" selected>否(免費參觀或未提供)</option>
                              <option value="1">是</option>
                            </select>
                          </div>
            </div>
            <div class="col-12 col-lg-6">
                    <div class="form-group bg-dark text-white rounded">
                            <label for="monthSelect" class="w-100 text-center pt-1">月</label>
                            <select class="form-control" id="monthSelect" data-next="saleSelect">
                              <option value="1">1</option>
                              <option value="2">2</option>
                              <option value="3">3</option>
                              <option value="4">4</option>
                              <option value="5">5</option>
                              <option value="6">6</option>
                              <option value="7">7</option>
                              <option value="8">8</option>
                              <option value="9">9</option>
                              <option value="10">10</option>
                              <option value="11">11</option>
                              <option value="12">12</option>
                            </select>
                          </div>
            </div>
            <div class="col-12 text-center my-4">
                    <button id="confirm" type="button" class="btn btn-danger bg-color2">確定</button>
            </div>
        </div>
        <div class="row my-4 bg-black-50" id="result">
            <div class="col-12 text-center text-dark tada wow">
                <h2 class="my-3 py-1 bg-white-50 rounded">搜尋結果</h2>
            </div>
            <div class="col-12 py-4 rounded">
                <table class="table table-light table-striped table-hover table-rwd w-100" id="showTable">
                    <thead class="thead-dark tr-hide">
                        <tr>
                            <th>活動名稱</th>
                            <th>主辦單位</th>
                            <th>起始日期</th>
                            <th>結束日期</th>
                            <th>介紹</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-footer mt-4" id="footer">
        <div class="row">
            <div class="col-12 text-center text-white">
                <ul class="nav justify-content-center">
                    <li class="nav-item">
                        資料來自於文化部所提供的展覽資訊開放資料。
                    </li>
                    <li class="nav-item">
                        &copy;2019泰山網頁設計班 Taylor
                    </li>
                </ul>
                
            </div>
        </div>
    </div>
    <div class="container-fluid" id="loading">
        <div class="row h-100">
            <div class="col-12 text-center align-self-center"><img src="./svg/hud.svg" alt="" height="300" width="300">
            <p class="text-black">讀取開放資料中</p>
            </div>
        </div>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog" id="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content bg-paper">
                <div class="modal-header">
                    <h5 class="modal-title break-word"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
        </div>
</body>
<script>
    let data;
    let citySelect = $("#citySelect");
    let monthSelect = $("#monthSelect");
    let yearSelect = $("#yearSelect");
    let saleSelect = $("#saleSelect");
    let result = {};
    let table;
    let chart = $("#chart");
    let myChart;

    $.get("api.php",function(res){
        datas=JSON.parse(res);
        console.log(datas);
        let total=0;
        let chartGroup = {
            label: [
                "北基宜花金馬",
                "桃竹苗",
                "中彰投",
                "雲嘉南",
                "高屏澎東",
                "其他",
            ],
            city: [
                ["1","2","3","18","19","21","22"],
                ["4","5","6","7"],
                ["8","9","10"],
                ["11","12","13","14"],
                ["15","16","17","20"],
                ["98","99"]
            ],
            count: [0,0,0,0,0,0],
            color: [
                `hsl(0, 50%, 50%)`,
                `hsl(60, 50%, 50%)`,
                `hsl(120, 50%, 50%)`,
                `hsl(180, 50%, 50%)`,
                `hsl(240, 50%, 50%)`,
                `hsl(300, 50%, 50%)`],
        }

        Object.entries(datas).forEach(([key,val])=>{
            // 地圖
            $(`.map-city#c${key}, .other-city#c${key}`).each(function(){
                // console.log($(this));
                total+=val.count;
                $(this).attr({
                    "data-toggle": "tooltip",
                    "data-placement": "bottom",
                    "data-html": "true",
                    "data-code": key,
                    title: `<h4>${val.name}</h4>展覽數量：${val.count}`
                });
                if($(this).attr("role"))$(this).attr("data-short",val.name[0]);
            })
            // 選單
            citySelect.append(`<option value="${key}">${val.name}(${val.count})</option>`);
            // 圖
            console.log(chartGroup.city.length);
            for(let i=0;i<chartGroup.city.length;i++){
                if(chartGroup.city[i].includes(key)){
                    chartGroup.count[i]+=val.count;
                    break;
                }
            }
        });
        $("#total").text(total);

        Chart.defaults.global.defaultFontColor = 'balck';
        Chart.defaults.global.defaultFontFamily = "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif, 'Microsoft JhengHei'";
        Chart.defaults.global.defaultFontSize = 16;
        chart.height= 700;
        myChart = new Chart(chart,{
            type: "bar",
            data: {
                labels: chartGroup.label,
                datasets:[
                    {
                        data: chartGroup.count,
                        backgroundColor: chartGroup.color
                    }
                ]
            },
            options: {
                title: {
                    text: `展覽統計(共${total})`,
                    display: true,
                    fontSize: 24,
                },
                legend: {
                    display: false,
                    position: "top",
                },
                scales: {
                    xAxes: [{
                        barThickness: "flex"
                    }]
                }
            }
        });
            
        $("#loading p").text("網頁載入中")
        $("#loading").fadeOut(1000,function(){
                $("#nav").fadeIn();
                $("#content").fadeIn();
                $("#footer").fadeIn();
                new WOW().init();
                $('[data-toggle="tooltip"]').tooltip({
                    template: '<div class="tooltip city" role="tooltip"><div class="arrow"></div><div class="tooltip-inner bg-color4"></div></div>'
                });
        })
    })
    particlesJS.load('night', './json/particlesjs-config.json', function() {
            console.log('callback - particles.js config loaded');
    });
    $.ajax({
        url: "./svg/taiwan.svg",
        success: function(result){
            // console.log($(result).find("svg"));
            $("#map").append($(result).find("svg"));
        }
        
    })

    $('body').scrollspy({ target: '#nav' });

    let d =new Date();
    let year=d.getFullYear();
    for(let i=year;i<=year+1;i++){
        yearSelect.append(`<option value="${i}">${i}</option>`);
    }
    yearSelect.find("option[value="+year+"]").prop("selected",true);
    monthSelect.find("option[value="+(d.getMonth()+1)+"]").prop("selected",true);


    $(".map-wrap").on("click",".map-city, .other-city",function(){
        console.log(citySelect.offset().top);
        citySelect.find("option[value="+$(this).data("code")+"]").prop("selected",true);
        $("html, body").animate({
            scrollTop: citySelect.offset().top-100
        },500)
    });
    

    $(".search-options select").on("change",function(){
        $("html, body").animate({
            scrollTop: $("#"+$(this).data("next")).offset().top-100
        },500);
        if($("#result").hasClass("d-flex"))$("#confirm").addClass("heartBeat animated slower infinite");
    });

    $("#confirm").on("click",function(){
        $("#confirm").removeClass("heartBeat animated slower infinite");
        if(table) table.destroy();
        $("#showTable tbody").empty();
        result = [];
        result.name = datas[citySelect.val()].name;
        result.shows = {};

        Object.entries(datas[citySelect.val()].shows).forEach(([key,val])=>{
            console.log(val.months);
            console.log(val.months[yearSelect.val()]);
            let sale = (val.onSales == "Y")?"1":"0";
            if((sale == saleSelect.val()) && val.months[yearSelect.val()] && val.months[yearSelect.val()].includes(parseInt(monthSelect.val()))){
                result.shows[key]=val;
                let unit = (val.masterUnit[0])?val.masterUnit[0]:((val.showUnit)?("演出單位："+val.showUnit):"未提供");
                $("#showTable tbody").append(/*html*/`
                    <tr>
                        <td data-th="活動名稱">${val.title}</td>
                        <td data-th="主辦單位">${unit}</td>
                        <td data-th="起始日期">${val.startDate}</td>
                        <td data-th="結束日期">${val.endDate}</td>
                        <td data-th="介紹" >
                            <button type="button" class="btn btn-link btn-more no-decoration" data-id="${key}">
                                <i class="fas fa-eye flash animated slower infinite"></i> 詳細資料
                            </button>
                        </td>
                    </tr>
                `)
            } 
        });
        console.log(result);
        table=$("#showTable").DataTable({
            "language":{
                "url": "./json/datatables-chinese-traditional.json"
            },
            "columns": [
                    {"width": "43%"},
                    {"width": "23%"},
                    {"width": "9%"},
                    {"width": "9%"},
                    {"width": "16%"},
            ],
            "columnDefs":[
                {
                    "targets": 4,
                    "orderable": false,
                    "searchable": false
                }
            ]
        });

        $("#result").addClass("d-flex");
        $("html, body").animate({
            scrollTop: $("#result").offset().top-60
        },500);
    });

    $("#showTable").on("click",".btn-more",function(){
        let show = result.shows[$(this).data("id")];
        console.log(show);
        $("#modal .modal-title").text(show.title);
        $("#modal .modal-body").empty();
        
        if(show.imageUrl){
            $("#modal .modal-body").append(/*html*/`
                <div class="d-flex justify-content-center mb-3">
                    <img src="${show.imageUrl}" class="mw-100 max-vh-25">
                </div>
            `);
        };

        let date = (show.startDate == show.endDate)?
            /*html*/`<li class="list-group-item flex-fill">${show.startDate}</li>`:
            /*html*/`
                <li class="list-group-item flex-fill text-center">${show.startDate}</li>
                <li class="list-group-item">至</li>
                <li class="list-group-item flex-fill text-center">${show.endDate}</li>
            `;
        $("#modal .modal-body").append(/*html*/`
            <h6 class="font-italic">展覽期間</h6>
            <div class="container-fluid">
                <ul class="list-group list-group-horizontal-sm mb-2 flex-wrap">${date}</ul>
            </div>
        `);

        let sale = (show.webSales)?/*html*/`<a target="_blank" href="${show.webSales}" class="badge badge-danger text-100 mx-2">售票網址</a>`:"";
        let prices = "";
        if(show.onSales == "Y"){
            if(show.price){
                let type = show.price.split(";");
                type.forEach(el=>{
                    let price = el.split("+");
                    if(price[1] && !isNaN(price[1])){
                        prices += /*html*/`<li class="list-group-item flex-fill">${price[0]}
                            <span class="badge badge-info badge-pill">${price[1]}元</span>
                        </li>`;
                    }else{
                        prices += (price[1])?
                            /*html*/`<li class="list-group-item flex-fill">${price[0]}+${price[1]}</li>`:
                            /*html*/`<li class="list-group-item flex-fill">${price[0]}</li>`;
                    }
                });
            }else{
                prices += /*html*/`<li class="list-group-item flex-fill">未提供售價，請洽詢展覽單位</li>`;
            }
        }else if(show.onSales == "N"){
            prices += /*html*/`<li class="list-group-item flex-fill">免費參觀</li>`;
        }else{
            prices += /*html*/`<li class="list-group-item flex-fill">未提供售票資訊，請洽詢展覽單位</li>`;
        }
        prices = /*html*/`<ul class="list-group list-group-horizontal-sm mb-2 flex-wrap">${prices}</ul>`;
        let discount = (show.discountInfo)?/*html*/`
            <div class="row justify-content-center">
                    <button type="button" class="btn btn-warning" data-trigger="focus" data-toggle="popover" data-placement="bottom" 
                    data-content="${show.discountInfo}">
                        折扣資訊
                    </button>

            </div>
        `:"";
        $("#modal .modal-body").append(/*html*/`
            <h6 class="font-italic">售票資訊${sale}</h6>
            <div class="container-fluid sale-info">
                ${prices}
                ${discount}
            </div>
        `);
        if(discount) $('[data-toggle="popover"]').popover({
            html: true
        });

        let units = "";
        if(show.masterUnit[0]) units +=  /*html*/`<li class="list-group-item flex-fill">主辦單位：${show.masterUnit[0]}</li>`;
        if(show.showUnit && show.showUnit != show.masterUnit[0] 
                && !show.showUnit.includes(show.masterUnit[0]) && !show.masterUnit[0].includes(show.showUnit)) {
            units +=  /*html*/`<li class="list-group-item flex-fill">演出單位：${show.showUnit}</li>`;
        }
        if(units){
            units = /*html*/`<ul class="list-group list-group-horizontal-sm mb-2 flex-wrap">${units}</ul>`;
            $("#modal .modal-body").append(/*html*/`
                <h6 class="font-italic">展覽單位</h6>
                <div class="container-fluid unit-info">
                    ${units}
                </div>
            `);
        }
        let location = "";
        if(show.locationName) location +=  /*html*/`<li class="list-group-item flex-fill">名稱：${show.locationName}</li>`;
        if(show.location) location +=  /*html*/`<li class="list-group-item flex-fill">地址：${show.location}</li>`;
        if(location){
            location = /*html*/`<ul class="list-group list-group-horizontal-sm mb-2 flex-wrap">${location}</ul>`;
            $("#modal .modal-body").append(/*html*/`
                <h6 class="font-italic">展覽地點</h6>
                <div class="container-fluid unit-info">
                    ${location}
                </div>
            `);
        }

        let link = (show.sourceWebPromote)?`<a target="_blank" href="${show.sourceWebPromote}" class="badge badge-success text-100 mx-2">活動網址</a>`:"";
        let intro = (show.descriptionFilterHtml)?/*html*/`
            <div class="card w-100">
                <div class="card-body">
                    <p class="card-text">${show.descriptionFilterHtml}</p>
                </div>
            </div>
        `:"";
        if(link || intro){
            $("#modal .modal-body").append(/*html*/`
                <h6 class="font-italic">展覽介紹${link}</h6>
                ${intro}
            `);
        }
        
        $("#modal").modal("show");
    })
</script>

</html>